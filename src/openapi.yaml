openapi: 3.0.3
info:
  title: Sleep Outside API
  version: 1.0.0
  description: >
    API for products, alerts, orders, reviews, users, and carts.
    Any GET collection endpoint returns a paginated wrapper:
    { count, next, previous, results }.

servers:
  - url: https://api.example.com

tags:
  - name: Products
  - name: Alerts
  - name: Orders
  - name: Reviews
  - name: Users
  - name: Cart

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorResponse:
      type: object
      additionalProperties: false
      required: [message]
      properties:
        message:
          type: string
        details:
          description: Optional field-level or validation detail.
          oneOf:
            - type: string
            - type: array
              items:
                type: string
            - type: object

    PaginatedLinks:
      type: object
      additionalProperties: false
      required: [count, next, previous, results]
      properties:
        count:
          type: number
          description: Total number of matching results.
        next:
          type: string
          nullable: true
          description: URL to next page or null if none.
        previous:
          type: string
          nullable: true
          description: URL to previous page or null if none.
        results:
          type: array
          items: {}

    Alert:
      type: object
      additionalProperties: false
      required: [_id, title, type, status, createdAt, modifiedAt]
      properties:
        _id:
          type: string
        title:
          type: string
          minLength: 1
          description: The title of the alert, must not be blank
        type:
          type: string
          enum: [warning, info, promotion]
        status:
          type: string
          enum: [active, inactive]
        createdAt:
          type: string
          format: date-time
        modifiedAt:
          type: string
          format: date-time

    Product:
      type: object
      additionalProperties: false
      required:
        - _id
        - id
        - isClearance
        - category
        - isNew
        - url
        - reviews
        - nameWithoutBrand
        - name
        - images
        - sizesAvailable
        - colors
        - descriptionHtmlSimple
        - suggestedRetailPrice
        - brand
        - listPrice
        - finalPrice
      properties:
        _id:
          type: string
        id:
          type: string
          minLength: 1
        isClearance:
          type: boolean
        category:
          type: string
          enum: [tents, backpacks, sleeping-bags, hammocks]
          description: Category of the product (tents, backpacks, sleeping-bags, hammocks)
        isNew:
          type: boolean
        url:
          type: string
          minLength: 1
        reviews:
          type: object
          additionalProperties: false
          required: [reviewsUrl, reviewCount, averageRating]
          properties:
            reviewsUrl:
              type: string
              minLength: 1
            reviewCount:
              type: number
              minimum: 0
            averageRating:
              type: number
              minimum: 0
              maximum: 5
        nameWithoutBrand:
          type: string
          minLength: 1
        name:
          type: string
          minLength: 1
        images:
          type: object
          additionalProperties: false
          required: [primarySmall, primaryMedium, primaryLarge, primaryExtraLarge, extraImages]
          properties:
            primarySmall:
              type: string
              minLength: 1
            primaryMedium:
              type: string
              minLength: 1
            primaryLarge:
              type: string
              minLength: 1
            primaryExtraLarge:
              type: string
              minLength: 1
            extraImages:
              type: array
              items:
                type: object
                additionalProperties: false
                required: [title, src]
                properties:
                  title:
                    type: string
                    minLength: 1
                  src:
                    type: string
                    minLength: 1
        sizesAvailable:
          type: object
          additionalProperties: false
          required: [zipper]
          properties:
            zipper:
              type: array
              items:
                type: string
        colors:
          type: array
          description: >
            Color options as an array of objects with colorCode, colorName,
            colorChipImageSrc, and colorPreviewImageSrc.
          items:
            type: object
            additionalProperties: false
            required: [colorCode, colorName, colorChipImageSrc, colorPreviewImageSrc]
            properties:
              colorCode:
                type: string
                minLength: 1
              colorName:
                type: string
                minLength: 1
              colorChipImageSrc:
                type: string
                minLength: 1
              colorPreviewImageSrc:
                type: string
                minLength: 1
        descriptionHtmlSimple:
          type: string
        suggestedRetailPrice:
          type: number
          minimum: 0
        brand:
          type: object
          additionalProperties: false
          required: [id, url, productsUrl, logoSrc, name]
          properties:
            id:
              type: string
              minLength: 1
            url:
              type: string
              minLength: 1
            productsUrl:
              type: string
              minLength: 1
            logoSrc:
              type: string
              minLength: 1
            name:
              type: string
              minLength: 1
        listPrice:
          type: number
          minimum: 0
        finalPrice:
          type: number
          minimum: 0

    Reviews:
      type: object
      additionalProperties: false
      required: [_id, product_id, content]
      properties:
        _id:
          type: string
        product_id:
          type: string
        content:
          type: array
          description: List of review texts
          items:
            type: string

    Order:
      type: object
      additionalProperties: false
      required: [_id, user_id, status, shipping_address, items, total, createdAt]
      properties:
        _id:
          type: string
        user_id:
          type: string
        status:
          type: object
          additionalProperties: false
          required: [isPaid, isShipped]
          properties:
            isPaid:
              type: boolean
            isShipped:
              type: boolean
        shipping_address:
          type: string
          minLength: 1
        items:
          type: array
          minItems: 1
          items:
            type: string
        total:
          type: number
        createdAt:
          type: string
          format: date-time

    EmbeddedCart:
      type: object
      additionalProperties: false
      required: [items]
      properties:
        items:
          type: array
          description: List of product ids
          items:
            type: string
        updatedAt:
          type: string
          format: date-time
          description: When the cart was last modified

    # Matches your DB document schema (includes hashedPassword)
    User:
      type: object
      additionalProperties: false
      required: [_id, name, email, hashedPassword, role]
      properties:
        _id:
          type: string
        name:
          type: object
          additionalProperties: false
          required: [firstName, lastName]
          properties:
            firstName:
              type: string
              minLength: 1
            lastName:
              type: string
              minLength: 1
        email:
          type: string
          format: email
        hashedPassword:
          type: string
          minLength: 1
        role:
          type: object
          additionalProperties: false
          required: [isCustomer, isAdmin]
          properties:
            isCustomer:
              type: boolean
            isAdmin:
              type: boolean
        cart:
          $ref: "#/components/schemas/EmbeddedCart"

    # What you actually return to clients (recommended)
    UserResponse:
      type: object
      additionalProperties: false
      required: [_id, name, email, role, cart]
      properties:
        _id:
          type: string
        name:
          type: object
          additionalProperties: false
          required: [firstName, lastName]
          properties:
            firstName:
              type: string
              minLength: 1
            lastName:
              type: string
              minLength: 1
        email:
          type: string
          format: email
        role:
          type: object
          additionalProperties: false
          required: [isCustomer, isAdmin]
          properties:
            isCustomer:
              type: boolean
            isAdmin:
              type: boolean
        cart:
          $ref: "#/components/schemas/EmbeddedCart"

    # Client payload to update cart (server sets updatedAt)
    CartUpdateRequest:
      type: object
      additionalProperties: false
      required: [items]
      properties:
        items:
          type: array
          description: List of product ids
          items:
            type: string

    ProductsListResponse:
      allOf:
        - $ref: "#/components/schemas/PaginatedLinks"
        - type: object
          additionalProperties: false
          properties:
            results:
              type: array
              items:
                $ref: "#/components/schemas/Product"

    AlertsListResponse:
      allOf:
        - $ref: "#/components/schemas/PaginatedLinks"
        - type: object
          additionalProperties: false
          properties:
            results:
              type: array
              items:
                $ref: "#/components/schemas/Alert"

    ReviewsListResponse:
      allOf:
        - $ref: "#/components/schemas/PaginatedLinks"
        - type: object
          additionalProperties: false
          properties:
            results:
              type: array
              items:
                $ref: "#/components/schemas/Reviews"

    # âœ… FIXED: list returns UserResponse (never leak hashedPassword)
    UsersListResponse:
      allOf:
        - $ref: "#/components/schemas/PaginatedLinks"
        - type: object
          additionalProperties: false
          properties:
            results:
              type: array
              items:
                $ref: "#/components/schemas/UserResponse"

    OrdersListResponse:
      allOf:
        - $ref: "#/components/schemas/PaginatedLinks"
        - type: object
          additionalProperties: false
          properties:
            results:
              type: array
              items:
                $ref: "#/components/schemas/Order"

  parameters:
    IdParam:
      name: id
      in: path
      required: true
      schema:
        type: string

paths:
  /products:
    get:
      tags: [Products]
      summary: List products
      description: >
        Returns a paginated list of products.
        Supports filtering, selecting fields, and pagination.
        # NOT PROTECTED (typically public catalog)
      parameters:
        - name: q
          in: query
          required: false
          schema: { type: string }
        - name: category
          in: query
          required: false
          schema:
            type: string
            enum: [tents, backpacks, sleeping-bags, hammocks]
        - name: fields
          in: query
          required: false
          description: Fields to include per product (server should filter properties accordingly).
          schema:
            type: array
            items: { type: string }
          style: form
          explode: true
        - name: limit
          in: query
          required: false
          schema:
            type: number
            minimum: 1
        - name: offset
          in: query
          required: false
          schema:
            type: number
            minimum: 0
      responses:
        "200":
          description: Paginated products response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductsListResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /products/{id}:
    get:
      tags: [Products]
      summary: Get product by id
      description: >
        Returns a single product.
        # NOT PROTECTED (typically public catalog)
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: A single product
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
        "404":
          description: Product not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              example:
                message: Product not found
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /alerts:
    get:
      tags: [Alerts]
      summary: List alerts
      description: >
        Returns a paginated list of alerts.
        # NOT PROTECTED (usually public marketing/info)
      responses:
        "200":
          description: Paginated alerts response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AlertsListResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /alerts/{id}:
    get:
      tags: [Alerts]
      summary: Get alert by id
      description: >
        Returns a single alert.
        # NOT PROTECTED (usually public marketing/info)
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: A single alert
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Alert"
        "404":
          description: Alert not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /orders:
    get:
      tags: [Orders]
      summary: List orders for current user
      description: >
        Returns a paginated list of orders belonging to the authenticated user.
        # PROTECTED: requires auth (user)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Paginated orders response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrdersListResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /orders/{id}:
    get:
      tags: [Orders]
      summary: Get order by id
      description: >
        Returns an order. Must belong to the authenticated user unless admin.
        # PROTECTED: requires auth (owner or admin)
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: A single order
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "404":
          description: Order not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /products/{id}/reviews:
    get:
      tags: [Reviews]
      summary: Get reviews for a product
      description: >
        Preferred way to fetch reviews: scoped to a single product.
        # NOT PROTECTED (typically public)
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: Paginated reviews response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReviewsListResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    post:
      tags: [Reviews]
      summary: Create a review for a product
      description: >
        Creates a review for the specified product.
        Server sets product_id from the path param (id).
        # PROTECTED: requires auth (user)
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdParam"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              required: [content]
              properties:
                content:
                  type: array
                  items: { type: string }
      responses:
        "201":
          description: Created review
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Reviews"
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /reviews/{id}:
    get:
      tags: [Reviews]
      summary: Get review document by id
      description: >
        Returns a single review document.
        # NOT PROTECTED (typically public)
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: A single review document
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Reviews"
        "404":
          description: Review not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    put:
      tags: [Reviews]
      summary: Update a review
      description: >
        Updates a review document.
        # PROTECTED: requires auth (owner or admin)
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdParam"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Reviews"
      responses:
        "200":
          description: Updated review
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Reviews"
        "404":
          description: Review not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    delete:
      tags: [Reviews]
      summary: Delete a review
      description: >
        Deletes a review document.
        # PROTECTED: requires auth (owner or admin)
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "204":
          description: Deleted
        "404":
          description: Review not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /user:
    get:
      tags: [Users]
      summary: Get current user profile
      description: >
        Returns the authenticated user's profile.
        # PROTECTED: requires auth (user)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Current user profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /user/{id}:
    get:
      tags: [Users]
      summary: Get user by id
      description: >
        Returns a user by id (typically admin use).
        # PROTECTED: requires auth (admin)
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdParam"
      responses:
        "200":
          description: A single user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "404":
          description: User not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /cart:
    get:
      tags: [Cart]
      summary: Get current user's cart
      description: >
        Returns the authenticated user's embedded cart (user.cart).
        # PROTECTED: requires auth (user)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: The user's embedded cart
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmbeddedCart"
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    post:
      tags: [Cart]
      summary: Replace current user's cart
      description: >
        Replaces the embedded cart (user.cart).
        Server sets updatedAt.
        # PROTECTED: requires auth (user)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CartUpdateRequest"
      responses:
        "201":
          description: Cart replaced
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmbeddedCart"
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    put:
      tags: [Cart]
      summary: Update current user's cart
      description: >
        Updates the embedded cart (user.cart).
        Server sets updatedAt.
        # PROTECTED: requires auth (user)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CartUpdateRequest"
      responses:
        "200":
          description: Updated cart
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmbeddedCart"
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    delete:
      tags: [Cart]
      summary: Clear current user's cart
      description: >
        Clears the embedded cart by setting items to [].
        Server sets updatedAt.
        # PROTECTED: requires auth (user)
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Cleared
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
